#                                                            #
# This file is distributed as part of the WannierBerri code  #
# under the terms of the GNU General Public License. See the #
# file 'LICENSE' in the root directory of the WannierBerri   #
# distribution, or http://www.gnu.org/copyleft/gpl.txt       #
#                                                            #
# The WannierBerri code is hosted on GitHub:                 #
# https://github.com/stepan-tsirkin/wannier-berri            #
#                     written by                             #
#           Stepan Tsirkin, University of Zurich             #
#   some parts of this file are originate                    #
# from the translation of Wannier90 code                     #
# ---------------------------------------------------------- #

import numpy as np
from termcolor import cprint

from .system_R import System_R
from ..fourier.rvectors import Rvectors


def System_ASE(
        ase_wannier,
        ws_dist_tol=1e-5,
        **parameters):
    """
    System initialized from the Wannier functions generated by `ASE <https://wiki.fysik.dtu.dk/ase/_modules/ase/dft/wannier.html>`__ .

    Parameters
    ----------
    ase_wannier :
        An object of  `ASE Wannier <https://wiki.fysik.dtu.dk/ase/_modules/ase/dft/wannier.html#Wannier>`__ .

    Notes
    -----
    see also  parameters of the :class:`~wannierberri.System`
    """

    if "name" not in parameters:
        parameters["name"] = "ASE"
    system = System_R(**parameters)
    ase_wannier.translate_all_to_cell()
    system.set_real_lattice(np.array(ase_wannier.unitcell_cc))
    mp_grid = ase_wannier.kptgrid


    system.num_wann = ase_wannier.nwannier
    system.num_kpts = ase_wannier.Nk
    system.wannier_centers_cart = ase_wannier.get_centers()
    print(f"got the Wannier centers : {system.wannier_centers_cart}")

    system.rvec = Rvectors(lattice=system.real_lattice, shifts_left_red=system.wannier_centers_red)
    system.rvec.set_Rvec(mp_grid=mp_grid, ws_tolerance=ws_dist_tol)

    system.rvec.set_fft_q_to_R(
        kpt_red=ase_wannier.kpt_kc
    )

    Ham = np.zeros(tuple(mp_grid) + (system.num_wann, system.num_wann), dtype=complex)
    for i in range(mp_grid[0]):
        for j in range(mp_grid[1]):
            for k in range(mp_grid[2]):
                Ham[i, j, k] = ase_wannier.get_hopping([i, j, k])

    system.set_R_mat('Ham', system.rvec.remap_XX_from_grid_to_list_R(Ham))

    system.do_at_end_of_init()

    cprint("Reading the ASE system finished successfully", 'green', attrs=['bold'])
    return system
